.include "x16a4def.inc"
.cseg
.org 0x100
.DSEG

.EQU PMIC_CTRL = 0x00A2

.EQU PORTB_DIR = 0x0620
.EQU PORTB_OUT = 0x0624
.EQU PORTB_PIN0CTRL = 0x0630
.EQU PORTB_PIN1CTRL = 0x0631
.EQU PORTB_PIN2CTRL = 0x0632
.EQU PORTB_INTCTRL = 0x0629
.EQU PORTB_INT0MASK = 0x062A
.EQU PORTB_INT1MASK = 0x062B

.EQU PORTC_DIR = 0x0640
.EQU PORTC_sts = 0x0644
.EQU PORTC_PIN0CTRL = 0x0650
.EQU PORTC_PIN7CTRL = 0x0657
.EQU	PORTC_INTCTRL = 0x0649
.EQU PORTC_INT0MASK = 0x064A
.EQU	PORTC_INT1MASK = 0x064B
.EQU	PORTC_PIN1CTRl = 0x0651
.EQU PORTC_MPCMASK = 0x00B0

.EQU ADCA_CTRLA = 0x0200
.EQU ADCA_CTRLB = 0x0201
.EQU ADCA_PRESCALER = 0x0204
.EQU ADCA_REFCTRL = 0x0202
.EQU	ADCA_CH0RES = 0x0210
.EQU	ADCA_CH0_MUXCTRL = 0x0221
.EQU ADCA_CMP = 0x0218
.EQU ADCA_CH0_INTCTRL = 0x0222
.EQU ADCA_CH1_INTCTRL = 0x0223
.EQU	ADCA_CH2_INTCTRL = 0x0224
.EQU ADCA_CH3_INTCTRL = 0x0225
.EQU ADCA_CH0_INTFLAGS = 0x0223

.EQU DACB_CTRLA = 0x0320
.EQU	DACB_CTRLB = 0x0321
.EQU DACB_CTRL C = 0x322
.EQU DACB_CH0DATA_LOW = 0x0338
.EQU	DACB_CH0DATA_HIGH = 0x0339
.EQU DACB_STATUS = 0x0325

.EQU OSC_CTRL = 0x0050
.EQU OSC_STATUS = 0x0051
.EQU OSC_DFLLCTRL = 0x0056

.EQU CLK_CTRL = 0x0040
.EQU CLK_PSCTRL = 0x0041

.EQU DFLLRC32M_CTRL = 0x0060

.EQU N_LO = 0x2004
.EQU N_HI = 0x2005
.EQU XN_LO = 0x2008
.EQU XN_HI = 0x2009
.EQU ADC_RES_LO = 0x0210
.EQU ADC_RES_HI = 0x0211
.EQU ADC_FLAG = 0x0223
.EQU PORTC = 0x0648
.EQU POINT_JMP = 0x2000
.EQU SINPOS_LO = 0x2002
.EQU SINPOS_HI = 0x2003

dac_write:
		ldi r5,0x00		
		lds r6, DACB_STATUS
wait_dac  sbrs r6,0
		rjmp wait_dac
		lds DACB_STATUS,r5
		sts DACB_CH0DATA_LOW,r24
		sts DACB_CH0DATA_HIGH,r25
		ret
main:

stack_init: 
		ldi r20, HIGH(RAMEND)
		out sph, r20
		ldi r20, LOW(RAMEND)
		out SPL, r20

board_init:
	
;Configura el puerto C
		ldi 	r16,0x80
		sts	PORTC_DIR,r16 
		ldi 	r16,0x00
		sts	PORTC_sts,r16 
		sts	PORTC_PIN0CTRL,r16 ; 0x0650 = PORTC_PIN0CTRL
		sts	PORTC_PIN7CTRL,r16 ; 0x0657 = PORTC_PIN7CTRL
		sts  PORTC_INTCTRL,r16 ; 0x0649 = PORTC_INTCTRL
		sts	PORTC_INT0MASK,r16
		sts	PORTC_INT1MASK,r16	
		ldi 	r16,0x12
		sts	PORTC_PIN1CTRL,r16o
		ldi 	r16,0xFC
		sts	PORTCFG_MPCMASK,r16

;Configura el puerto B
		ldi	r16,0x0C
		sts	PORTB_DIR,r16	
		ldi	r16,0x00
		sts	PORTB_OUT,r16
		sts	PORTB_PIN0CTRL,r16
		sts	PORTB_PIN1CTRL,r16
		sts	PORTB_INTCTRL,r16
		sts	PORTB_INT0MASK,r16
		sts	PORTB_INT1MASK,r16
		ldi	r16,0x07
		sts	PORTB_PIN2CTRL,r16
		
adc_init:	
		ldi	r16,0x10
		sts	ADCA_CTRLB,r16 ;Modo con signo y 12 bit de resolución
		ldi	r16,0x04
		sts	ADCA_PRESCALER,r16 ;Se setea CLK_ADC = CLK_PER/64
		ldi	r16,0x10
		sts	ADCA_REFCTRL,r16 ;Seleccion de referencia a VCC/1.6 V
		ldi	r16,0x01
		sts	ADCA_CH0_CTRL,r16 ;Setea el Single Ended Input
		ldi	r16,0x00
		sts	ADCA_CMP,r16
		ldi	r16,0x38
		sts	ADCA_CH0_MUXCTRL,r16 ;Seteo el PIN7 como input del ADCA_CH0
		ldi	r16,0x02
		sts	ADCA_CH0_INTCTRL,r16 ;Seteo cuando avisa que termina la conversión
		ldi	r16,0x00
		sts	ADCA_CH1_INTCTRL,r16 
		sts	ADCA_CH2_INTCTRL,r16
		sts	ADCA_CH3_INTCTRL,r16	
		ldi	r16,0x01
		sts	PMIC_CTRL,r16 ;Habilito interrupciones de baja prioridad
		SEI ;Habilito interrupciones globales
		ldi	r16,0x18
		sts	ADCA_CTRLB,r16 ;Seteo el modo de ADC en free-running
		ldi	r16,0x01
		sts	ADCA_CTRLA,r16 ;Habilito el ADC
clk_init:
		ldi	r16,0x00
		sts	OSC_CTRL,r16 ;Deshabilito todas las fuentes de clock
		ldi	r16,0x04
		sts	OSC_CTRL,r16 ;Habilito RC32K oscilador
		
		lds	r16,OSC_STATUS
polling32K:
		sbrs	r16,0 ;Espero a que estabilice
		rjmp	polling32K
		ldi	r16,0x06 
		sts	OSC_CTRL,r16 ;Habilito RC32M oscilador
		ldi	r16,0xD8
		sts	CCP,r16 ;Deshabilita IOs protegidos para actualizar la configuración
		ldi	r16,0x00
		sts	CLK_PSCTRL,r16	;Se setea el prescaler del clock en DIV1
		sts	OSC_DFLLCTRL,r16 ;Calibro el RC32M con el RC32K
		ldi	r16,0x01
		sts	DFLLRC32M_CTRL,r16 ;Habilito la auto-calibración

		lds	r16,OSC_STATUS
polling32M:
		sbrs	r16,1 ;Espero a que estabilice el RC32M
		rjmp polling32M
		ldi	r16,0xD8
		sts	CCP,r16 ;Deshabilita IOs protegidos para actualizar la configuración
		ldi	r16,0x01
		sts	CLK_CTRL,r16 ;Selecciona el clock source al RC32M
		ldi	r16,0x02
		sts	OSC_CTRL,r16 ;Deshabilita todos las otras clock sources
	
dac_init:
		ldi	r16,0x09
		sts	DACB_CTRLA,r16
		ldi	r16,0x00
		sts	DACB_CTRLB,r16
		ldi	r16,0x04
		sts	DACB_CTRLC,r16
		ret


		ldi	r28, 0x01	
		ldi	r29, 0x01	
WAIT_ADC:	lds	r24, ADC_FLAG	; flag de conversión lista
		sbrs	r24, 0	
		jmp	WAIT_ADC	
		sts	ADC_FLAG, r28	; poner en cero el flag de conversión
		lds	r24, ADC_RES_LO	; leer valor del ADC
		lds	r25, ADC_RES_HI	; leer valor del ADC
		sts	XN_LO, r24	; muestra x[n]
		sts	XN_HI, r25	; muestra x[n]
		lds	r18, N_LO	; traer valor de n
		lds	r19, N_HI	; traer valor de n
		movw	r30, r18	; cálculo de la posición de memoria
		add	r30, r30	; cálculo de la posición de memoria
		adc	r31, r31	; cálculo de la posición de memoria
		subi	r30, 0xF6	; cálculo de la posición de memoria
		sbci	r31, 0xDF	; cálculo de la posición de memoria
		st	Z, r24		; almacenar x[n] en la memoria
		std	Z+1, r25	; almacenar x[n] en la memoria
		lds	r20, PORTC	; lectura del portC
		sbrs	r20, 1	; chequeo si se presionó el botón de cambiar frecuencia
		jmp	RST_FREC	
		lds	r20, POINT_JMP	
		subi	r20, 0xFF	
		sts	POINT_JMP, r20	
RST_FREC:	lds	r20, POINT_JMP	; chequea que la frecuencia no supere el maximo de 10
		cpi	R20, 10	
		brcs	READY_FREC	
		sts	POINT_JMP, r29	
READY_FREC:	lds	r20, SINPOS_LO	; leo posición de la tabla
		lds	r21, SINPOS_HI	; leo posición de la tabla
		mov	r30, r21	
		eor	r31, r31	
		add	r30, r30	; cálculo de posición de la tabla
		adc	r31, r31	
		subi	r30, 0x88	
		sbci	r31, 0xFE	
		lpm	r30, Z		; lectura de nb de la tabla de valores
		ldi	r31, 0x00	
		sts	0x2006, r30	
		sts	0x2007, r31	
		lds	r22, 0x2000	
		add	r20, r22	
		adc	r21, r1	; creo que acá hace acc+=saltear
		sts	SINPOS_LO, r20	; guardo posición de la tabla en memoria SRAM
		sts	SINPOS_HI, r21	; guardo posición de la tabla en memoria SRAM
		sub	r18, r30	; resolvemos nb_posta= n-nb
		sbc	r19, r31	; resolvemos nb_posta= n-nb
		cpi	R18, 0xE9	; cargo 1001 en R20|R18
		ldi	R20, 0x03	; cargo 1001 en R20|R18
		cpc	r19, r20	; verifico si desbordé la memoria
		brcs	SALTAR_MEM	; verifico si desbordé la memoria
		subi	r18, 0x18	; le sumamos para no salir de la memoria circular
		sbci	r19, 0xFC	; le sumamos para no salir de la memoria circular
SALTAR_MEM:	sts	0x27DA, r18	; almacenamos nb_posta en memoria
		sts	0x27DB, r19	; almacenamos nb_posta en memoria
		lds	r18, 0x0648	; leemos estado de on/off del efecto
		sbrs	r18, 0	; confirmamos que esté o no activado
		rjmp	FX_OFF	; 0x13ce <main+0xcc>
		lds	r30, 0x27DA	; cargo Z con la dirección de x[n-nb]
		lds	r31, 0x27DB	; cargo Z con la dirección de x[n-nb]
		add	r30, r30	
		adc	r31, r31	
		subi	r30, 0xF6	
		sbci	r31, 0xDF	
		ld	r18, Z	; traigo el valor de x[n-nb] de memoria
		ldd	r19, Z+1	; traigo el valor de x[n-nb] de memoria
		add	r24, r18	; lo sumo con la muestra actual
		adc	r25, r19	; lo sumo con la muestra actual
FX_OFF:	call	dac_write	; lo sacamos por el DAC
		lds	r24, N_LO	
		lds	r25, N_HI	
		adiw	r24, 0x01	; incrementamos valor de n
		sts	N_LO, r24	; almacenamos n 
		sts	N_HI, r25	; almacenamos n 
		cpi	r24, 0xE8	; verifico si desbordé la memoria
		sbci	r25, 0x03	; verifico si desbordé la memoria
		brcc	RST_MEM	; verifico si desbordé la memoria
		jmp	WAIT_ADC	
RST_MEM:	sts	N_LO, r1	; reiniciar posición de memoria cíclica
		sts	N_HI, r1	; reiniciar posición de memoria cíclica
		jmp	WAIT_ADC	

 
.org 0x200			
tabla: .db
125,125,126,126,127,127,127,128,128,128,129,129,130,130,130,131,131,132,132,132,133,133,133,134,134,135,135,135,136,136,136,137,
137,138,138,138,139,139,140,140,140,141,141,141,142,142,143,143,143,144,144,144,145,145,146,146,146,147,147,148,148,148,149,149,
149,150,150,151,151,151,152,152,152,153,153,154,154,154,155,155,155,156,156,156,157,157,158,158,158,159,159,159,160,160,161,161,
161,162,162,162,163,163,163,164,164,165,165,165,166,166,166,167,167,167,168,168,169,169,169,170,170,170,171,171,171,172,172,172,
173,173,174,174,174,175,175,175,176,176,176,177,177,177,178,178,178,179,179,179,180,180,181,181,181,182,182,182,183,183,183,184,
184,184,185,185,185,186,186,186,187,187,187,188,188,188,189,189,189,190,190,190,191,191,191,192,192,192,193,193,193,193,194,194,
194,195,195,195,196,196,196,197,197,197,198,198,198,199,199,199,199,200,200,200,201,201,201,202,202,202,203,203,203,203,204,204,
204,205,205,205,205,206,206,206,207,207,207,208,208,208,208,209,209,209,210,210,210,210,211,211,211,211,212,212,212,213,213,213,
213,214,214,214,214,215,215,215,216,216,216,216,217,217,217,217,218,218,218,218,219,219,219,219,220,220,220,220,221,221,221,221,
222,222,222,222,223,223,223,223,224,224,224,224,224,225,225,225,225,226,226,226,226,227,227,227,227,227,228,228,228,228,229,229,
229,229,229,230,230,230,230,230,231,231,231,231,231,232,232,232,232,232,233,233,233,233,233,234,234,234,234,234,235,235,235,235,
235,235,236,236,236,236,236,236,237,237,237,237,237,238,238,238,238,238,238,238,239,239,239,239,239,239,240,240,240,240,240,240,
240,241,241,241,241,241,241,241,242,242,242,242,242,242,242,243,243,243,243,243,243,243,243,244,244,244,244,244,244,244,244,245,
245,245,245,245,245,245,245,245,245,246,246,246,246,246,246,246,246,246,246,247,247,247,247,247,247,247,247,247,247,247,247,248,
248,248,248,248,248,248,248,248,248,248,248,248,248,248,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,
249,249,249,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,
250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,249,249,
249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,248,248,248,248,248,248,248,248,248,248,248,248,248,
248,248,247,247,247,247,247,247,247,247,247,247,247,247,246,246,246,246,246,246,246,246,246,246,245,245,245,245,245,245,245,245,
245,245,244,244,244,244,244,244,244,244,243,243,243,243,243,243,243,243,242,242,242,242,242,242,242,241,241,241,241,241,241,241,
240,240,240,240,240,240,240,239,239,239,239,239,239,238,238,238,238,238,238,238,237,237,237,237,237,236,236,236,236,236,236,235,
235,235,235,235,235,234,234,234,234,234,233,233,233,233,233,232,232,232,232,232,231,231,231,231,231,230,230,230,230,230,229,229,
229,229,229,228,228,228,228,227,227,227,227,227,226,226,226,226,225,225,225,225,224,224,224,224,224,223,223,223,223,222,222,222,
222,221,221,221,221,220,220,220,220,219,219,219,219,218,218,218,218,217,217,217,217,216,216,216,216,215,215,215,214,214,214,214,
213,213,213,213,212,212,212,211,211,211,211,210,210,210,210,209,209,209,208,208,208,208,207,207,207,206,206,206,205,205,205,205,
204,204,204,203,203,203,203,202,202,202,201,201,201,200,200,200,199,199,199,199,198,198,198,197,197,197,196,196,196,195,195,195,
194,194,194,193,193,193,193,192,192,192,191,191,191,190,190,190,189,189,189,188,188,188,187,187,187,186,186,186,185,185,185,184,
184,184,183,183,183,182,182,182,181,181,181,180,180,179,179,179,178,178,178,177,177,177,176,176,176,175,175,175,174,174,174,173,
173,172,172,172,171,171,171,170,170,170,169,169,169,168,168,167,167,167,166,166,166,165,165,165,164,164,163,163,163,162,162,162,
161,161,161,160,160,159,159,159,158,158,158,157,157,156,156,156,155,155,155,154,154,154,153,153,152,152,152,151,151,151,150,150,
149,149,149,148,148,148,147,147,146,146,146,145,145,144,144,144,143,143,143,142,142,141,141,141,140,140,140,139,139,138,138,138,
137,137,136,136,136,135,135,135,134,134,133,133,133,132,132,132,131,131,130,130,130,129,129,128,128,128,127,127,127,126,126,125,
125,125,124,124,123,123,123,122,122,122,121,121,120,120,120,119,119,118,118,118,117,117,117,116,116,115,115,115,114,114,114,113,
113,112,112,112,111,111,110,110,110,109,109,109,108,108,107,107,107,106,106,106,105,105,104,104,104,103,103,102,102,102,101,101,
101,100,100,99,99,99,98,98,98,97,97,96,96,96,95,95,95,94,94,94,93,93,92,92,92,91,91,91,90,90,89,89,
89,88,88,88,87,87,87,86,86,85,85,85,84,84,84,83,83,83,82,82,81,81,81,80,80,80,79,79,79,78,78,78,
77,77,76,76,76,75,75,75,74,74,74,73,73,73,72,72,72,71,71,71,70,70,69,69,69,68,68,68,67,67,67,66,
66,66,65,65,65,64,64,64,63,63,63,62,62,62,61,61,61,60,60,60,59,59,59,58,58,58,57,57,57,57,56,56,
56,55,55,55,54,54,54,53,53,53,52,52,52,51,51,51,51,50,50,50,49,49,49,48,48,48,47,47,47,47,46,46,
46,45,45,45,45,44,44,44,43,43,43,42,42,42,42,41,41,41,40,40,40,40,39,39,39,39,38,38,38,37,37,37,
37,36,36,36,36,35,35,35,34,34,34,34,33,33,33,33,32,32,32,32,31,31,31,31,30,30,30,30,29,29,29,29,
28,28,28,28,27,27,27,27,26,26,26,26,26,25,25,25,25,24,24,24,24,23,23,23,23,23,22,22,22,22,21,21,
21,21,21,20,20,20,20,20,19,19,19,19,19,18,18,18,18,18,17,17,17,17,17,16,16,16,16,16,15,15,15,15,
15,15,14,14,14,14,14,14,13,13,13,13,13,12,12,12,12,12,12,12,11,11,11,11,11,11,10,10,10,10,10,10,
10,9,9,9,9,9,9,9,8,8,8,8,8,8,8,7,7,7,7,7,7,7,7,6,6,6,6,6,6,6,6,5,
5,5,5,5,5,5,5,5,5,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,2,
2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,
2,2,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,9,9,9,9,9,9,9,
10,10,10,10,10,10,10,11,11,11,11,11,11,12,12,12,12,12,12,12,13,13,13,13,13,14,14,14,14,14,14,15,
15,15,15,15,15,16,16,16,16,16,17,17,17,17,17,18,18,18,18,18,19,19,19,19,19,20,20,20,20,20,21,21,
21,21,21,22,22,22,22,23,23,23,23,23,24,24,24,24,25,25,25,25,26,26,26,26,26,27,27,27,27,28,28,28,
28,29,29,29,29,30,30,30,30,31,31,31,31,32,32,32,32,33,33,33,33,34,34,34,34,35,35,35,36,36,36,36,
37,37,37,37,38,38,38,39,39,39,39,40,40,40,40,41,41,41,42,42,42,42,43,43,43,44,44,44,45,45,45,45,
46,46,46,47,47,47,47,48,48,48,49,49,49,50,50,50,51,51,51,51,52,52,52,53,53,53,54,54,54,55,55,55,
56,56,56,57,57,57,57,58,58,58,59,59,59,60,60,60,61,61,61,62,62,62,63,63,63,64,64,64,65,65,65,66,
66,66,67,67,67,68,68,68,69,69,69,70,70,71,71,71,72,72,72,73,73,73,74,74,74,75,75,75,76,76,76,77,
77,78,78,78,79,79,79,80,80,80,81,81,81,82,82,83,83,83,84,84,84,85,85,85,86,86,87,87,87,88,88,88,
89,89,89,90,90,91,91,91,92,92,92,93,93,94,94,94,95,95,95,96,96,96,97,97,98,98,98,99,99,99,100,100,
101,101,101,102,102,102,103,103,104,104,104,105,105,106,106,106,
107,107,107,108,108,109,109,109,110,110,110,111,111,112,112,112,113,113,114,114,114,115,115,115,116,116,117,117,117,118,118,118,
119,119,120,120,120,121,121,122,122,122,123,123,123,124,124,125

